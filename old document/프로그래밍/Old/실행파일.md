# 윈도우의 실행파일
우리는 흔히 EXE 확장자를 가진 파일을 실행파일이라고 얘기한다. 이렇게 실행되는 프로그램들은 흔히 하드디스크 상에 EXE라는 확장자를 가진 파일로 존재한다. 그리고 실행 프로그램 또는 응용 애플리케이션이라고 불리는 EXE 파일 말고도 프로그램 실행을 위한 동적 링크 라이브러리라는 DLL 파일도 프로그램 실행 시에 같이 물려 메모리 상에 로드된다. 이러한 EXE 파일과 관련 DLL 파일들이 메모리 상에 로드되면서 비로소 프로그램이라는 것이 사용 가능하게 되고 이렇게 로드된 하나의 EXE와 여러 개의 관련 DLL들이 소위 운영체제론에서 이야기하는 하나의 프로세스(process)를 구성하게 된다.

이 외에도 윈도우에서 사용되는 실행 파일 종류들은 다음과 같다.

#### 실행 계열 
* exe(실행파일)
* scr(스크린세이버)
* msi(윈도우즈 패키지 인스톨 프로그램)
* bat(명령어 배치파일)
* cmd(명령어 스크립트)
* bs(VB 스크립트) 등

#### 라이브러리 계열
* dll(동적 라이브러리)
* ocx(OLE 개체 컨트롤)
* cpl(윈도우즈 컨트롤 판넬)
* drv(장치 관리)
* sys(시스템 디바이스) 등

## Windows Loader에 의한 파일 실행
흔히 우리가 응용 프로그램이라고 부르는 EXE 파일 역시 나름대로의 포맷을 가진다. 

EXE 파일을 로드하는 역할을 담당하는 것이 Win32 운영체제의 서브시스템으로 존재하는 프로그램 로더이고 EXE의 파일 구조는 이 로더가 식별할 수 있는 방식으로 구성된다. 특정 EXE를 실행하게 되면 이 로더가 해당 EXE 파일을 열고 그 파일 구조를 분석해서 적절하게 메모리에 로드하여 프로그램의 진입점으로 들어가게 한다. 또한 프로그램을 로드하는 동안 EXE 파일 내부의 임포트 정보를 통해 필요한 DLL 역시 찾아서 메모리 상에 로드하게 된다.

### 실행파일(EXE)과 라이브러리 파일(DLL)
그런데 여기서 한가지 의문점이 생긴다. 과연 DLL 파일과 EXE 파일은 서로 완전히 다른 종류의 파일인 것인가?? 정답을 말하자면 두 파일은 같은 구조를 가진다. 

## PE 파일이란 무엇인가?
마이크로소프트는 이 두 파일에 사용하는 포맷을 `“PE 파일”` 이라고 명명한다.

PE는 “Portable Executable”의 약자로써 win32 운영체제가 돌아가는 시스템이면 어디서든지(portable) 실행이 가능하다는(executable) 의미로 이러한 이름을 붙였다. 즉, 인텔 프로세서(CPU) 기반의 윈도우가 탑재된 시스템에서 돌아가는 PE 프로그램은 DEC-ALPHA 프로세서를 탑재한 시스템 상에 인스톨된 Win32 운영체제 하에서도 실행 가능하다는 것이다. 

이러한 파일들을 얘기할 때 대부분 이미지(Image)라는 용어를 들어본 적이 있을 것이다. 특히 가상 메모리 영역에서 메모리에 로드된 실행 파일들을 파일이라 부르지 않고 Image라고 부르는데, 이것은 BMP, JPG 와 같은 그림, 사진 등의 이미지와는 절대적으로 다른 것이다. 즉, 단순한 의미의 Image 가 아니라 어떤 실체에 대한 그림자, 허상, 그것의 반영 이라는 의미에서의 Image를 뜻한다. 

메모리에 로드된 실행 파일이 그 실행 파일 자체라고는 말할 수 없다. 즉, 하드디스크에 실질적으로 존재하는 실행파일과 메모리에 로드된 실행파일의 이미지는 물리적인 위치부터 같은 것이 아니다. 한마디로 Image 라는 것은 그 실행파일의 참조자 정도로 표현할 수 있다. 하지만 이 두 파일을 같은 것으로 보아도 무방하다. 어차피 기본적으로 같은 녀석이기 때문에 이와 같은 PE 파일이 메모리에 로드될 때 VMM (Virtual Memory Manager)은 페이지 파일을 사용하지 않고 PE 파일 자체를 마치 페이지 파일처럼 가상 주소 공간에 그대로 매핑한다. Win32 프로그래머들이 프로세스간 통신을 위해 애용하는 “공유 메모리” 메커니즘을 통해 PE 파일 자체를 직접 가상 주소 공간과 매핑해 버리는 것이다. 

“공유 메모리”라고 알려진 IPC 통신 방식은 실제 메모리에 매핑된 파일(memory mapped file)이며 어찌 보면 원래 PE 파일을 효율적으로 메모리에 로드하기 위해 MS가 고안해낸 방식을 그 범위를 넓혀 IPC에도 이용할 수 있도록 다른 사용 용도를 제안한 것일 수도 있다. 이와 같이 PE 포맷은 매우 복잡한 구조를 가지고 있다.

PE 파일에는 파일이 실행되는 정보를 볼 수 있고 어느 메모리에서 로딩되는지 등의 정보를 알 수 있다. 원래는 다양한 운영체제에서의 이식성을 좋게 하려는 의도였으나 실제 windows 계열의 운영체제에서만 사용한다. 

## 참고
[날으는물고기 블로그](https://m.blog.naver.com/PostView.naver?isHttpsRedirect=true&blogId=choibit&logNo=140038928254)  
[dma 블로그](https://choimungu.tistory.com/70?category=884930)
